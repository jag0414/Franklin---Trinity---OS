name: Secret Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  secret-scan:
    name: Scan for API Keys and Secrets
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better scanning
    
    - name: Install scanning tools
      run: |
        # Install gitleaks for secret detection
        wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz
        tar -xzf gitleaks_8.18.1_linux_x64.tar.gz
        chmod +x gitleaks
        sudo mv gitleaks /usr/local/bin/
    
    - name: Run Gitleaks
      run: |
        gitleaks detect --source . --verbose --no-git
    
    - name: Custom Pattern Scan
      run: |
        echo "ğŸ” Scanning for API key patterns..."
        
        # Patterns to detect
        PATTERNS=(
          "sk-proj-[A-Za-z0-9]{40,}"
          "sk-[A-Za-z0-9]{48,}"
          "sk-ant-[A-Za-z0-9]{40,}"
          "AIza[A-Za-z0-9_-]{35}"
        )
        
        FOUND=0
        
        for pattern in "${PATTERNS[@]}"; do
          echo "Checking pattern: $pattern"
          if grep -rE "$pattern" . \
             --exclude-dir=node_modules \
             --exclude-dir=.git \
             --exclude-dir=dist \
             --exclude-dir=build \
             --exclude-dir=__pycache__ \
             --exclude="*.md" \
             --exclude=".env.example" \
             --exclude="RAILWAY_VARIABLES.env"; then
            echo "âŒ FOUND SECRET matching pattern: $pattern"
            FOUND=1
          fi
        done
        
        if [ $FOUND -eq 1 ]; then
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  SECRETS DETECTED - BLOCKING WORKFLOW              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "See SECURITY.md for remediation steps."
          exit 1
        else
          echo "âœ… No secrets detected."
        fi
    
    - name: Check for .env files
      run: |
        echo "ğŸ” Checking for committed .env files..."
        
        if find . -name ".env" -not -path "*/node_modules/*" -not -path "*/.git/*" | grep -q .; then
          echo "âŒ ERROR: .env file found in repository!"
          find . -name ".env" -not -path "*/node_modules/*" -not -path "*/.git/*"
          echo ""
          echo "The .env file should NEVER be committed."
          echo "Only .env.example should be in the repository."
          exit 1
        else
          echo "âœ… No .env files found in repository."
        fi
    
    - name: Verify .gitignore
      run: |
        echo "ğŸ” Verifying .gitignore includes .env..."
        
        if ! grep -q "^\.env$" .gitignore; then
          echo "âš ï¸  WARNING: .env not found in .gitignore"
          echo "Adding .env to .gitignore is recommended."
          exit 1
        else
          echo "âœ… .env is properly gitignored."
        fi
    
    - name: Security Summary
      if: success()
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  âœ… SECURITY SCAN PASSED                           â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "No secrets or API keys detected in the repository."
        echo "For more information, see SECURITY.md"
